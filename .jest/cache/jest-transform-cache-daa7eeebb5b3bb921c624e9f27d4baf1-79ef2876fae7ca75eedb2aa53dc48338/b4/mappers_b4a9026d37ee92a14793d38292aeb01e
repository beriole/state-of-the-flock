22b4a4a4696529b657333e9278ce12c9
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startMapper = startMapper;
exports.stopMapper = stopMapper;
var _PlatformChecker = require("./PlatformChecker");
var _threads = require("./threads");
var _isSharedValue = require("./isSharedValue");
var IS_JEST = (0, _PlatformChecker.isJest)();
function createMapperRegistry() {
  'worklet';

  var mappers = new Map();
  var sortedMappers = [];
  var runRequested = false;
  var processingMappers = false;
  function updateMappersOrder() {
    var pre = new Map();
    mappers.forEach(function (mapper) {
      if (mapper.outputs) {
        for (var output of mapper.outputs) {
          var preMappers = pre.get(output);
          if (preMappers === undefined) {
            pre.set(output, [mapper]);
          } else {
            preMappers.push(mapper);
          }
        }
      }
    });
    var visited = new Set();
    var newOrder = [];
    function dfs(mapper) {
      visited.add(mapper);
      for (var input of mapper.inputs) {
        var preMappers = pre.get(input);
        if (preMappers) {
          for (var preMapper of preMappers) {
            if (!visited.has(preMapper)) {
              dfs(preMapper);
            }
          }
        }
      }
      newOrder.push(mapper);
    }
    mappers.forEach(function (mapper) {
      if (!visited.has(mapper)) {
        dfs(mapper);
      }
    });
    sortedMappers = newOrder;
  }
  function mapperRun() {
    runRequested = false;
    if (processingMappers) {
      return;
    }
    try {
      processingMappers = true;
      if (mappers.size !== sortedMappers.length) {
        updateMappersOrder();
      }
      for (var mapper of sortedMappers) {
        if (mapper.dirty) {
          mapper.dirty = false;
          mapper.worklet();
        }
      }
    } finally {
      processingMappers = false;
    }
  }
  function maybeRequestUpdates() {
    if (IS_JEST) {
      mapperRun();
    } else if (!runRequested) {
      if (processingMappers) {
        requestAnimationFrame(mapperRun);
      } else {
        queueMicrotask(mapperRun);
      }
      runRequested = true;
    }
  }
  function extractInputs(inputs, resultArray) {
    if (Array.isArray(inputs)) {
      for (var input of inputs) {
        input && extractInputs(input, resultArray);
      }
    } else if ((0, _isSharedValue.isSharedValue)(inputs)) {
      resultArray.push(inputs);
    } else if (Object.getPrototypeOf(inputs) === Object.prototype) {
      for (var element of Object.values(inputs)) {
        element && extractInputs(element, resultArray);
      }
    }
    return resultArray;
  }
  return {
    start: function start(mapperID, worklet, inputs, outputs) {
      var mapper = {
        id: mapperID,
        dirty: true,
        worklet: worklet,
        inputs: extractInputs(inputs, []),
        outputs: outputs
      };
      mappers.set(mapper.id, mapper);
      sortedMappers = [];
      for (var sv of mapper.inputs) {
        sv.addListener(mapper.id, function () {
          mapper.dirty = true;
          maybeRequestUpdates();
        });
      }
      maybeRequestUpdates();
    },
    stop: function stop(mapperID) {
      var mapper = mappers.get(mapperID);
      if (mapper) {
        mappers.delete(mapper.id);
        sortedMappers = [];
        for (var sv of mapper.inputs) {
          sv.removeListener(mapper.id);
        }
      }
    }
  };
}
var MAPPER_ID = 9999;
function startMapper(worklet) {
  var inputs = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  var outputs = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];
  var mapperID = MAPPER_ID += 1;
  (0, _threads.runOnUI)(function () {
    var mapperRegistry = global.__mapperRegistry;
    if (mapperRegistry === undefined) {
      mapperRegistry = global.__mapperRegistry = createMapperRegistry();
    }
    mapperRegistry.start(mapperID, worklet, inputs, outputs);
  })();
  return mapperID;
}
function stopMapper(mapperID) {
  (0, _threads.runOnUI)(function () {
    var mapperRegistry = global.__mapperRegistry;
    mapperRegistry == null || mapperRegistry.stop(mapperID);
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInN0YXJ0TWFwcGVyIiwic3RvcE1hcHBlciIsIl9QbGF0Zm9ybUNoZWNrZXIiLCJyZXF1aXJlIiwiX3RocmVhZHMiLCJfaXNTaGFyZWRWYWx1ZSIsIklTX0pFU1QiLCJpc0plc3QiLCJjcmVhdGVNYXBwZXJSZWdpc3RyeSIsIm1hcHBlcnMiLCJNYXAiLCJzb3J0ZWRNYXBwZXJzIiwicnVuUmVxdWVzdGVkIiwicHJvY2Vzc2luZ01hcHBlcnMiLCJ1cGRhdGVNYXBwZXJzT3JkZXIiLCJwcmUiLCJmb3JFYWNoIiwibWFwcGVyIiwib3V0cHV0cyIsIm91dHB1dCIsInByZU1hcHBlcnMiLCJnZXQiLCJ1bmRlZmluZWQiLCJzZXQiLCJwdXNoIiwidmlzaXRlZCIsIlNldCIsIm5ld09yZGVyIiwiZGZzIiwiYWRkIiwiaW5wdXQiLCJpbnB1dHMiLCJwcmVNYXBwZXIiLCJoYXMiLCJtYXBwZXJSdW4iLCJzaXplIiwibGVuZ3RoIiwiZGlydHkiLCJ3b3JrbGV0IiwibWF5YmVSZXF1ZXN0VXBkYXRlcyIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInF1ZXVlTWljcm90YXNrIiwiZXh0cmFjdElucHV0cyIsInJlc3VsdEFycmF5IiwiQXJyYXkiLCJpc0FycmF5IiwiaXNTaGFyZWRWYWx1ZSIsImdldFByb3RvdHlwZU9mIiwicHJvdG90eXBlIiwiZWxlbWVudCIsInZhbHVlcyIsInN0YXJ0IiwibWFwcGVySUQiLCJpZCIsInN2IiwiYWRkTGlzdGVuZXIiLCJzdG9wIiwiZGVsZXRlIiwicmVtb3ZlTGlzdGVuZXIiLCJNQVBQRVJfSUQiLCJhcmd1bWVudHMiLCJydW5PblVJIiwibWFwcGVyUmVnaXN0cnkiLCJnbG9iYWwiLCJfX21hcHBlclJlZ2lzdHJ5Il0sInNvdXJjZXMiOlsibWFwcGVycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5pbXBvcnQgdHlwZSB7XG4gIE1hcHBlclJhd0lucHV0cyxcbiAgTWFwcGVyT3V0cHV0cyxcbiAgU2hhcmVkVmFsdWUsXG59IGZyb20gJy4vY29tbW9uVHlwZXMnO1xuaW1wb3J0IHsgaXNKZXN0IH0gZnJvbSAnLi9QbGF0Zm9ybUNoZWNrZXInO1xuaW1wb3J0IHsgcnVuT25VSSB9IGZyb20gJy4vdGhyZWFkcyc7XG5pbXBvcnQgeyBpc1NoYXJlZFZhbHVlIH0gZnJvbSAnLi9pc1NoYXJlZFZhbHVlJztcblxuY29uc3QgSVNfSkVTVCA9IGlzSmVzdCgpO1xuXG50eXBlIE1hcHBlckV4dHJhY3RlZElucHV0cyA9IFNoYXJlZFZhbHVlW107XG5cbnR5cGUgTWFwcGVyID0ge1xuICBpZDogbnVtYmVyO1xuICBkaXJ0eTogYm9vbGVhbjtcbiAgd29ya2xldDogKCkgPT4gdm9pZDtcbiAgaW5wdXRzOiBNYXBwZXJFeHRyYWN0ZWRJbnB1dHM7XG4gIG91dHB1dHM/OiBNYXBwZXJPdXRwdXRzO1xufTtcblxuZnVuY3Rpb24gY3JlYXRlTWFwcGVyUmVnaXN0cnkoKSB7XG4gICd3b3JrbGV0JztcbiAgY29uc3QgbWFwcGVycyA9IG5ldyBNYXA8bnVtYmVyLCBNYXBwZXI+KCk7XG4gIGxldCBzb3J0ZWRNYXBwZXJzOiBNYXBwZXJbXSA9IFtdO1xuXG4gIGxldCBydW5SZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgbGV0IHByb2Nlc3NpbmdNYXBwZXJzID0gZmFsc2U7XG5cbiAgZnVuY3Rpb24gdXBkYXRlTWFwcGVyc09yZGVyKCkge1xuICAgIC8vIHNvcnQgbWFwcGVycyB0b3BvbG9naWNhbGx5XG4gICAgLy8gdGhlIGFsZ29yaXRobSBoZXJlIHRha2VzIGFkdmVudGFnZSBvZiBhIGZhY3QgdGhhdCB0aGUgdG9wb2xvZ2ljYWwgb3JkZXJcbiAgICAvLyBvZiBhIHRyYW5zcG9zZWQgZ3JhcGggaXMgYSByZXZlcnNlIHRvcG9sb2dpY2FsIG9yZGVyIG9mIHRoZSBvcmlnaW5hbCBncmFwaFxuICAgIC8vIFRoZSBncmFwaCBpbiBvdXIgY2FzZSBjb25zaXN0cyBvZiBtYXBwZXJzIGFuZCBhbiBlZGdlIGJldHdlZW4gdHdvIG1hcHBlcnNcbiAgICAvLyBBIGFuZCBCIGV4aXN0cyBpZiB0aGVyZSBpcyBhIHNoYXJlZCB2YWx1ZSB0aGF0J3Mgb24gQSdzIG91dHB1dCBsaXN0cyBhbmQgb25cbiAgICAvLyBCJ3MgaW5wdXQgbGlzdC5cbiAgICAvL1xuICAgIC8vIFdlIGRvbid0IG5lZWQgaG93ZXZlciB0byBjYWxjdWxhdGUgdGhhdCBncmFwaCBhcyBpdCBpcyBlYXNpZXIgdG8gd29yayB3aXRoXG4gICAgLy8gdGhlIHRyYW5zcG9zZWQgdmVyc2lvbiBvZiBpdCB0aGF0IGNhbiBiZSBjYWxjdWxhdGVkIGFkLWhvYy4gRm9yIHRoZSB0cmFuc3Bvc2VkXG4gICAgLy8gdmVyc2lvbiB0byBiZSB0cmF2ZXJzZWQgd2UgdXNlIFwicHJlXCIgbWFwIHRoYXQgbWFwcyBzaGFyZSB2YWx1ZSB0byBtYXBwZXJzIHRoYXRcbiAgICAvLyBvdXRwdXQgdGhhdCBzaGFyZWQgdmFsdWUuIFRoZW4gd2UgY2FuIGluZmVyIGFsbCB0aGUgb3V0Z29pbmcgZWRnZXMgZm9yIGEgZ2l2ZW5cbiAgICAvLyBtYXBwZXIgc2ltcGx5IGJ5IHNjYW5uaW5nIGl0J3MgaW5wdXQgbGlzdCBhbmQgY2hlY2tpbmcgaWYgYW55IG9mIHRoZSBzaGFyZWQgdmFsdWVzXG4gICAgLy8gZnJvbSB0aGF0IGxpc3QgZXhpc3RzIGluIHRoZSBcInByZVwiIG1hcC4gSWYgdGhleSBkbywgdGhlbiB3ZSBoYXZlIGFuIGVkZ2UgYmV0d2VlblxuICAgIC8vIHRoYXQgbWFwcGVyIGFuZCB0aGUgbWFwcGVycyBmcm9tIHRoZSBcInByZVwiIGxpc3QgZm9yIHRoZSBnaXZlbiBzaGFyZWQgdmFsdWUuXG4gICAgLy9cbiAgICAvLyBGb3IgdG9wb2xvZ2ljYWwgc29ydGluZyB3ZSB1c2UgYSBkZnMtYmFzZWQgYXBwcm9hY2ggdGhhdCByZXF1aXJlcyB0aGUgZ3JhcGggdG9cbiAgICAvLyBiZSB0cmF2ZXJzZWQgaW4gZGZzIG9yZGVyIGFuZCBlYWNoIG5vZGUgYWZ0ZXIgYmVpbmcgcHJvY2Vzc2VkIGxhbmRzIGF0IHRoZVxuICAgIC8vIGJlZ2lubmluZyBvZiB0aGUgdG9wb2xvZ2ljYWwgb3JkZXIgbGlzdC4gU2luY2Ugd2UgdHJhdmVyc2UgYSB0cmFuc3Bvc2VkIGdyYXBoLFxuICAgIC8vIGluc3RlYWQgb2YgcmV2ZXJzaW5nIHRoYXQgb3JkZXIgd2UgY2FuIHVzZSBhIG5vcm1hbCBhcnJheSBhbmQgcHVzaCBwcm9jZXNzZWRcbiAgICAvLyBtYXBwZXJzIHRvIHRoZSBlbmQuIFRoZXJlIGlzIG5vIG5lZWQgdG8gcmV2ZXJzZSB0aGF0IGFycmF5IGFmdGVyIHdlIGFyZSBkb25lLlxuICAgIGNvbnN0IHByZSA9IG5ldyBNYXAoKTsgLy8gbWFwIGZyb20gc3YgLT4gbWFwcGVyIHRoYXQgb3V0cHV0cyB0aGF0IHN2XG4gICAgbWFwcGVycy5mb3JFYWNoKChtYXBwZXIpID0+IHtcbiAgICAgIGlmIChtYXBwZXIub3V0cHV0cykge1xuICAgICAgICBmb3IgKGNvbnN0IG91dHB1dCBvZiBtYXBwZXIub3V0cHV0cykge1xuICAgICAgICAgIGNvbnN0IHByZU1hcHBlcnMgPSBwcmUuZ2V0KG91dHB1dCk7XG4gICAgICAgICAgaWYgKHByZU1hcHBlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcHJlLnNldChvdXRwdXQsIFttYXBwZXJdKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJlTWFwcGVycy5wdXNoKG1hcHBlcik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQoKTtcbiAgICBjb25zdCBuZXdPcmRlcjogTWFwcGVyW10gPSBbXTtcbiAgICBmdW5jdGlvbiBkZnMobWFwcGVyOiBNYXBwZXIpIHtcbiAgICAgIHZpc2l0ZWQuYWRkKG1hcHBlcik7XG4gICAgICBmb3IgKGNvbnN0IGlucHV0IG9mIG1hcHBlci5pbnB1dHMpIHtcbiAgICAgICAgY29uc3QgcHJlTWFwcGVycyA9IHByZS5nZXQoaW5wdXQpO1xuICAgICAgICBpZiAocHJlTWFwcGVycykge1xuICAgICAgICAgIGZvciAoY29uc3QgcHJlTWFwcGVyIG9mIHByZU1hcHBlcnMpIHtcbiAgICAgICAgICAgIGlmICghdmlzaXRlZC5oYXMocHJlTWFwcGVyKSkge1xuICAgICAgICAgICAgICBkZnMocHJlTWFwcGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIG5ld09yZGVyLnB1c2gobWFwcGVyKTtcbiAgICB9XG4gICAgbWFwcGVycy5mb3JFYWNoKChtYXBwZXIpID0+IHtcbiAgICAgIGlmICghdmlzaXRlZC5oYXMobWFwcGVyKSkge1xuICAgICAgICBkZnMobWFwcGVyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBzb3J0ZWRNYXBwZXJzID0gbmV3T3JkZXI7XG4gIH1cblxuICBmdW5jdGlvbiBtYXBwZXJSdW4oKSB7XG4gICAgcnVuUmVxdWVzdGVkID0gZmFsc2U7XG4gICAgaWYgKHByb2Nlc3NpbmdNYXBwZXJzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBwcm9jZXNzaW5nTWFwcGVycyA9IHRydWU7XG4gICAgICBpZiAobWFwcGVycy5zaXplICE9PSBzb3J0ZWRNYXBwZXJzLmxlbmd0aCkge1xuICAgICAgICB1cGRhdGVNYXBwZXJzT3JkZXIoKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgbWFwcGVyIG9mIHNvcnRlZE1hcHBlcnMpIHtcbiAgICAgICAgaWYgKG1hcHBlci5kaXJ0eSkge1xuICAgICAgICAgIG1hcHBlci5kaXJ0eSA9IGZhbHNlO1xuICAgICAgICAgIG1hcHBlci53b3JrbGV0KCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgcHJvY2Vzc2luZ01hcHBlcnMgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBtYXliZVJlcXVlc3RVcGRhdGVzKCkge1xuICAgIGlmIChJU19KRVNUKSB7XG4gICAgICAvLyBPbiBKZXN0IGVudmlyb25tZW50IHdlIGF2b2lkIHVzaW5nIHF1ZXVlTWljcm90YXNrIGFzIHRoYXQnZCByZXF1aXJlIHRlc3RcbiAgICAgIC8vIHRvIGFkdmFuY2UgdGhlIGNsb2NrIG1hbnVhbGx5LiBUaGlzIG9uIG90aGVyIGhhbmQgd291bGQgcmVxdWlyZSB0ZXN0c1xuICAgICAgLy8gdG8ga25vdyBob3cgbWFueSB0aW1lcyBtYXBwZXJzIG5lZWQgdG8gcnVuLiBBcyB3ZSBkb24ndCB3YW50IHRlc3RzIHRvXG4gICAgICAvLyBtYWtlIGFueSBhc3N1bXB0aW9ucyBvbiB0aGF0IG51bWJlciBpdCBpcyBlYXNpZXIgdG8gZXhlY3V0ZSBtYXBwZXJzXG4gICAgICAvLyBpbW1lZGlhdGVseSBmb3IgdGVzdGluZyBwdXJwb3NlcyBhbmQgb25seSBleHBlY3QgdGVzdCB0byBhZHZhbmNlIHRpbWVyc1xuICAgICAgLy8gaWYgdGhleSB3YW50IHRvIG1ha2UgYW55IGFzc2VydGlvbnMgb24gdGhlIGVmZmVjdHMgb2YgYW5pbWF0aW9ucyBiZWluZyBydW4uXG4gICAgICBtYXBwZXJSdW4oKTtcbiAgICB9IGVsc2UgaWYgKCFydW5SZXF1ZXN0ZWQpIHtcbiAgICAgIGlmIChwcm9jZXNzaW5nTWFwcGVycykge1xuICAgICAgICAvLyBJbiBnZW5lcmFsLCB3ZSBzaG91bGQgYXZvaWQgaGF2aW5nIG1hcHBlcnMgdHJpZ2dlciB1cGRhdGVzIGFzIHRoaXMgbWF5XG4gICAgICAgIC8vIHJlc3VsdCBpbiB1bnByZWRpY3RhYmxlIGJlaGF2aW9yLiBTcGVjaWZpY2FsbHksIHRoZSB1cGRhdGVkIHZhbHVlIGNhblxuICAgICAgICAvLyBiZSByZWFkIGJ5IG1hcHBlcnMgdGhhdCBydW4gbGF0ZXIgaW4gdGhlIHNhbWUgZnJhbWUgYnV0IHByZXZpb3VzIG1hcHBlcnNcbiAgICAgICAgLy8gd291bGQgYWNjZXNzIHRoZSBvbGQgdmFsdWUuIFVwZGF0aW5nIG1hcHBlcnMgZHVyaW5nIHRoZSBtYXBwZXItcnVuIHBoYXNlXG4gICAgICAgIC8vIGJyZWFrcyB0aGUgb3JkZXIgaW4gd2hpY2ggd2Ugc2hvdWxkIGV4ZWN1dGUgdGhlIG1hcHBlcnMuIEhvd2V2ZXIsIGRvaW5nXG4gICAgICAgIC8vIHRoYXQgaXMgc3RpbGwgYSBwb3NzaWJpbGl0eSBhbmQgdGhlcmUgYXJlIHNvbWUgaW5zdGFuY2VzIHdoZXJlIHBlb3BsZSB1c2VcbiAgICAgICAgLy8gdGhlIEFQSSBpbiB0aGF0IHdheSwgaGVuY2Ugd2UgbmVlZCB0byBwcmV2ZW50IG1hcHBlci1ydW4gcGhhc2UgZmFsbGluZyBpbnRvXG4gICAgICAgIC8vIGFuIGluZmluaXRlIGxvb3AuIFdlIGRvIHRoYXQgYnkgZGV0ZWN0aW5nIHdoZW4gbWFwcGVyLXJ1biBpcyByZXF1ZXN0ZWQgd2hpbGVcbiAgICAgICAgLy8gd2UgYXJlIGFscmVhZHkgaW4gbWFwcGVyLXJ1biBwaGFzZSwgYW5kIGluIHRoYXQgY2FzZSB3ZSB1c2UgYHJlcXVlc3RBbmltYXRpb25GcmFtZWBcbiAgICAgICAgLy8gaW5zdGVhZCBvZiBgcXVldWVNaWNyb3Rhc2tgIHdoaWNoIHdpbGwgc2NoZWR1bGUgbWFwcGVyIHJ1biBmb3IgdGhlIG5leHRcbiAgICAgICAgLy8gZnJhbWUgaW5zdGVhZCBvZiBxdWV1aW5nIGFub3RoZXIgc2V0IG9mIHVwZGF0ZXMgaW4gdGhlIHNhbWUgZnJhbWUuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShtYXBwZXJSdW4pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcXVldWVNaWNyb3Rhc2sobWFwcGVyUnVuKTtcbiAgICAgIH1cbiAgICAgIHJ1blJlcXVlc3RlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gZXh0cmFjdElucHV0cyhcbiAgICBpbnB1dHM6IHVua25vd24sXG4gICAgcmVzdWx0QXJyYXk6IE1hcHBlckV4dHJhY3RlZElucHV0c1xuICApOiBNYXBwZXJFeHRyYWN0ZWRJbnB1dHMge1xuICAgIGlmIChBcnJheS5pc0FycmF5KGlucHV0cykpIHtcbiAgICAgIGZvciAoY29uc3QgaW5wdXQgb2YgaW5wdXRzKSB7XG4gICAgICAgIGlucHV0ICYmIGV4dHJhY3RJbnB1dHMoaW5wdXQsIHJlc3VsdEFycmF5KTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzU2hhcmVkVmFsdWUoaW5wdXRzKSkge1xuICAgICAgcmVzdWx0QXJyYXkucHVzaChpbnB1dHMpO1xuICAgIH0gZWxzZSBpZiAoT2JqZWN0LmdldFByb3RvdHlwZU9mKGlucHV0cykgPT09IE9iamVjdC5wcm90b3R5cGUpIHtcbiAgICAgIC8vIHdlIG9ubHkgZXh0cmFjdCBpbnB1dHMgcmVjdXJzaXZlbHkgZnJvbSBcInBsYWluXCIgb2JqZWN0cyBoZXJlLCBpZiBvYmplY3RcbiAgICAgIC8vIGlzIG9mIGEgZGVyaXZhdGl2ZSBjbGFzcyAoZS5nLiBIb3N0T2JqZWN0IG9uIHdlYiwgb3IgTWFwKSB3ZSBkb24ndCBzY2FuXG4gICAgICAvLyBpdCByZWN1cnNpdmVseVxuICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIE9iamVjdC52YWx1ZXMoaW5wdXRzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KSkge1xuICAgICAgICBlbGVtZW50ICYmIGV4dHJhY3RJbnB1dHMoZWxlbWVudCwgcmVzdWx0QXJyYXkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0QXJyYXk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHN0YXJ0OiAoXG4gICAgICBtYXBwZXJJRDogbnVtYmVyLFxuICAgICAgd29ya2xldDogKCkgPT4gdm9pZCxcbiAgICAgIGlucHV0czogTWFwcGVyUmF3SW5wdXRzLFxuICAgICAgb3V0cHV0cz86IE1hcHBlck91dHB1dHNcbiAgICApID0+IHtcbiAgICAgIGNvbnN0IG1hcHBlcjogTWFwcGVyID0ge1xuICAgICAgICBpZDogbWFwcGVySUQsXG4gICAgICAgIGRpcnR5OiB0cnVlLFxuICAgICAgICB3b3JrbGV0LFxuICAgICAgICBpbnB1dHM6IGV4dHJhY3RJbnB1dHMoaW5wdXRzLCBbXSksXG4gICAgICAgIG91dHB1dHMsXG4gICAgICB9O1xuICAgICAgbWFwcGVycy5zZXQobWFwcGVyLmlkLCBtYXBwZXIpO1xuICAgICAgc29ydGVkTWFwcGVycyA9IFtdO1xuICAgICAgZm9yIChjb25zdCBzdiBvZiBtYXBwZXIuaW5wdXRzKSB7XG4gICAgICAgIHN2LmFkZExpc3RlbmVyKG1hcHBlci5pZCwgKCkgPT4ge1xuICAgICAgICAgIG1hcHBlci5kaXJ0eSA9IHRydWU7XG4gICAgICAgICAgbWF5YmVSZXF1ZXN0VXBkYXRlcygpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIG1heWJlUmVxdWVzdFVwZGF0ZXMoKTtcbiAgICB9LFxuICAgIHN0b3A6IChtYXBwZXJJRDogbnVtYmVyKSA9PiB7XG4gICAgICBjb25zdCBtYXBwZXIgPSBtYXBwZXJzLmdldChtYXBwZXJJRCk7XG4gICAgICBpZiAobWFwcGVyKSB7XG4gICAgICAgIG1hcHBlcnMuZGVsZXRlKG1hcHBlci5pZCk7XG4gICAgICAgIHNvcnRlZE1hcHBlcnMgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBzdiBvZiBtYXBwZXIuaW5wdXRzKSB7XG4gICAgICAgICAgc3YucmVtb3ZlTGlzdGVuZXIobWFwcGVyLmlkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gIH07XG59XG5cbmxldCBNQVBQRVJfSUQgPSA5OTk5O1xuXG5leHBvcnQgZnVuY3Rpb24gc3RhcnRNYXBwZXIoXG4gIHdvcmtsZXQ6ICgpID0+IHZvaWQsXG4gIGlucHV0czogTWFwcGVyUmF3SW5wdXRzID0gW10sXG4gIG91dHB1dHM6IE1hcHBlck91dHB1dHMgPSBbXVxuKTogbnVtYmVyIHtcbiAgY29uc3QgbWFwcGVySUQgPSAoTUFQUEVSX0lEICs9IDEpO1xuXG4gIHJ1bk9uVUkoKCkgPT4ge1xuICAgIGxldCBtYXBwZXJSZWdpc3RyeSA9IGdsb2JhbC5fX21hcHBlclJlZ2lzdHJ5O1xuICAgIGlmIChtYXBwZXJSZWdpc3RyeSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBtYXBwZXJSZWdpc3RyeSA9IGdsb2JhbC5fX21hcHBlclJlZ2lzdHJ5ID0gY3JlYXRlTWFwcGVyUmVnaXN0cnkoKTtcbiAgICB9XG4gICAgbWFwcGVyUmVnaXN0cnkuc3RhcnQobWFwcGVySUQsIHdvcmtsZXQsIGlucHV0cywgb3V0cHV0cyk7XG4gIH0pKCk7XG5cbiAgcmV0dXJuIG1hcHBlcklEO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RvcE1hcHBlcihtYXBwZXJJRDogbnVtYmVyKTogdm9pZCB7XG4gIHJ1bk9uVUkoKCkgPT4ge1xuICAgIGNvbnN0IG1hcHBlclJlZ2lzdHJ5ID0gZ2xvYmFsLl9fbWFwcGVyUmVnaXN0cnk7XG4gICAgbWFwcGVyUmVnaXN0cnk/LnN0b3AobWFwcGVySUQpO1xuICB9KSgpO1xufVxuIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZOztBQUFDQSxNQUFBLENBQUFDLGNBQUEsQ0FBQUMsT0FBQTtFQUFBQyxLQUFBO0FBQUE7QUFBQUQsT0FBQSxDQUFBRSxXQUFBLEdBQUFBLFdBQUE7QUFBQUYsT0FBQSxDQUFBRyxVQUFBLEdBQUFBLFVBQUE7QUFNYixJQUFBQyxnQkFBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsUUFBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsY0FBQSxHQUFBRixPQUFBO0FBRUEsSUFBTUcsT0FBTyxHQUFHLElBQUFDLHVCQUFNLEVBQUMsQ0FBQztBQVl4QixTQUFTQyxvQkFBb0JBLENBQUEsRUFBRztFQUM5QixTQUFTOztFQUNULElBQU1DLE9BQU8sR0FBRyxJQUFJQyxHQUFHLENBQWlCLENBQUM7RUFDekMsSUFBSUMsYUFBdUIsR0FBRyxFQUFFO0VBRWhDLElBQUlDLFlBQVksR0FBRyxLQUFLO0VBQ3hCLElBQUlDLGlCQUFpQixHQUFHLEtBQUs7RUFFN0IsU0FBU0Msa0JBQWtCQSxDQUFBLEVBQUc7SUFxQjVCLElBQU1DLEdBQUcsR0FBRyxJQUFJTCxHQUFHLENBQUMsQ0FBQztJQUNyQkQsT0FBTyxDQUFDTyxPQUFPLENBQUMsVUFBQ0MsTUFBTSxFQUFLO01BQzFCLElBQUlBLE1BQU0sQ0FBQ0MsT0FBTyxFQUFFO1FBQ2xCLEtBQUssSUFBTUMsTUFBTSxJQUFJRixNQUFNLENBQUNDLE9BQU8sRUFBRTtVQUNuQyxJQUFNRSxVQUFVLEdBQUdMLEdBQUcsQ0FBQ00sR0FBRyxDQUFDRixNQUFNLENBQUM7VUFDbEMsSUFBSUMsVUFBVSxLQUFLRSxTQUFTLEVBQUU7WUFDNUJQLEdBQUcsQ0FBQ1EsR0FBRyxDQUFDSixNQUFNLEVBQUUsQ0FBQ0YsTUFBTSxDQUFDLENBQUM7VUFDM0IsQ0FBQyxNQUFNO1lBQ0xHLFVBQVUsQ0FBQ0ksSUFBSSxDQUFDUCxNQUFNLENBQUM7VUFDekI7UUFDRjtNQUNGO0lBQ0YsQ0FBQyxDQUFDO0lBQ0YsSUFBTVEsT0FBTyxHQUFHLElBQUlDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLElBQU1DLFFBQWtCLEdBQUcsRUFBRTtJQUM3QixTQUFTQyxHQUFHQSxDQUFDWCxNQUFjLEVBQUU7TUFDM0JRLE9BQU8sQ0FBQ0ksR0FBRyxDQUFDWixNQUFNLENBQUM7TUFDbkIsS0FBSyxJQUFNYSxLQUFLLElBQUliLE1BQU0sQ0FBQ2MsTUFBTSxFQUFFO1FBQ2pDLElBQU1YLFVBQVUsR0FBR0wsR0FBRyxDQUFDTSxHQUFHLENBQUNTLEtBQUssQ0FBQztRQUNqQyxJQUFJVixVQUFVLEVBQUU7VUFDZCxLQUFLLElBQU1ZLFNBQVMsSUFBSVosVUFBVSxFQUFFO1lBQ2xDLElBQUksQ0FBQ0ssT0FBTyxDQUFDUSxHQUFHLENBQUNELFNBQVMsQ0FBQyxFQUFFO2NBQzNCSixHQUFHLENBQUNJLFNBQVMsQ0FBQztZQUNoQjtVQUNGO1FBQ0Y7TUFDRjtNQUNBTCxRQUFRLENBQUNILElBQUksQ0FBQ1AsTUFBTSxDQUFDO0lBQ3ZCO0lBQ0FSLE9BQU8sQ0FBQ08sT0FBTyxDQUFDLFVBQUNDLE1BQU0sRUFBSztNQUMxQixJQUFJLENBQUNRLE9BQU8sQ0FBQ1EsR0FBRyxDQUFDaEIsTUFBTSxDQUFDLEVBQUU7UUFDeEJXLEdBQUcsQ0FBQ1gsTUFBTSxDQUFDO01BQ2I7SUFDRixDQUFDLENBQUM7SUFDRk4sYUFBYSxHQUFHZ0IsUUFBUTtFQUMxQjtFQUVBLFNBQVNPLFNBQVNBLENBQUEsRUFBRztJQUNuQnRCLFlBQVksR0FBRyxLQUFLO0lBQ3BCLElBQUlDLGlCQUFpQixFQUFFO01BQ3JCO0lBQ0Y7SUFDQSxJQUFJO01BQ0ZBLGlCQUFpQixHQUFHLElBQUk7TUFDeEIsSUFBSUosT0FBTyxDQUFDMEIsSUFBSSxLQUFLeEIsYUFBYSxDQUFDeUIsTUFBTSxFQUFFO1FBQ3pDdEIsa0JBQWtCLENBQUMsQ0FBQztNQUN0QjtNQUNBLEtBQUssSUFBTUcsTUFBTSxJQUFJTixhQUFhLEVBQUU7UUFDbEMsSUFBSU0sTUFBTSxDQUFDb0IsS0FBSyxFQUFFO1VBQ2hCcEIsTUFBTSxDQUFDb0IsS0FBSyxHQUFHLEtBQUs7VUFDcEJwQixNQUFNLENBQUNxQixPQUFPLENBQUMsQ0FBQztRQUNsQjtNQUNGO0lBQ0YsQ0FBQyxTQUFTO01BQ1J6QixpQkFBaUIsR0FBRyxLQUFLO0lBQzNCO0VBQ0Y7RUFFQSxTQUFTMEIsbUJBQW1CQSxDQUFBLEVBQUc7SUFDN0IsSUFBSWpDLE9BQU8sRUFBRTtNQU9YNEIsU0FBUyxDQUFDLENBQUM7SUFDYixDQUFDLE1BQU0sSUFBSSxDQUFDdEIsWUFBWSxFQUFFO01BQ3hCLElBQUlDLGlCQUFpQixFQUFFO1FBWXJCMkIscUJBQXFCLENBQUNOLFNBQVMsQ0FBQztNQUNsQyxDQUFDLE1BQU07UUFDTE8sY0FBYyxDQUFDUCxTQUFTLENBQUM7TUFDM0I7TUFDQXRCLFlBQVksR0FBRyxJQUFJO0lBQ3JCO0VBQ0Y7RUFFQSxTQUFTOEIsYUFBYUEsQ0FDcEJYLE1BQWUsRUFDZlksV0FBa0MsRUFDWDtJQUN2QixJQUFJQyxLQUFLLENBQUNDLE9BQU8sQ0FBQ2QsTUFBTSxDQUFDLEVBQUU7TUFDekIsS0FBSyxJQUFNRCxLQUFLLElBQUlDLE1BQU0sRUFBRTtRQUMxQkQsS0FBSyxJQUFJWSxhQUFhLENBQUNaLEtBQUssRUFBRWEsV0FBVyxDQUFDO01BQzVDO0lBQ0YsQ0FBQyxNQUFNLElBQUksSUFBQUcsNEJBQWEsRUFBQ2YsTUFBTSxDQUFDLEVBQUU7TUFDaENZLFdBQVcsQ0FBQ25CLElBQUksQ0FBQ08sTUFBTSxDQUFDO0lBQzFCLENBQUMsTUFBTSxJQUFJbkMsTUFBTSxDQUFDbUQsY0FBYyxDQUFDaEIsTUFBTSxDQUFDLEtBQUtuQyxNQUFNLENBQUNvRCxTQUFTLEVBQUU7TUFJN0QsS0FBSyxJQUFNQyxPQUFPLElBQUlyRCxNQUFNLENBQUNzRCxNQUFNLENBQUNuQixNQUFpQyxDQUFDLEVBQUU7UUFDdEVrQixPQUFPLElBQUlQLGFBQWEsQ0FBQ08sT0FBTyxFQUFFTixXQUFXLENBQUM7TUFDaEQ7SUFDRjtJQUNBLE9BQU9BLFdBQVc7RUFDcEI7RUFFQSxPQUFPO0lBQ0xRLEtBQUssRUFBRSxTQUFQQSxLQUFLQSxDQUNIQyxRQUFnQixFQUNoQmQsT0FBbUIsRUFDbkJQLE1BQXVCLEVBQ3ZCYixPQUF1QixFQUNwQjtNQUNILElBQU1ELE1BQWMsR0FBRztRQUNyQm9DLEVBQUUsRUFBRUQsUUFBUTtRQUNaZixLQUFLLEVBQUUsSUFBSTtRQUNYQyxPQUFPLEVBQVBBLE9BQU87UUFDUFAsTUFBTSxFQUFFVyxhQUFhLENBQUNYLE1BQU0sRUFBRSxFQUFFLENBQUM7UUFDakNiLE9BQU8sRUFBUEE7TUFDRixDQUFDO01BQ0RULE9BQU8sQ0FBQ2MsR0FBRyxDQUFDTixNQUFNLENBQUNvQyxFQUFFLEVBQUVwQyxNQUFNLENBQUM7TUFDOUJOLGFBQWEsR0FBRyxFQUFFO01BQ2xCLEtBQUssSUFBTTJDLEVBQUUsSUFBSXJDLE1BQU0sQ0FBQ2MsTUFBTSxFQUFFO1FBQzlCdUIsRUFBRSxDQUFDQyxXQUFXLENBQUN0QyxNQUFNLENBQUNvQyxFQUFFLEVBQUUsWUFBTTtVQUM5QnBDLE1BQU0sQ0FBQ29CLEtBQUssR0FBRyxJQUFJO1VBQ25CRSxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3ZCLENBQUMsQ0FBQztNQUNKO01BQ0FBLG1CQUFtQixDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUNEaUIsSUFBSSxFQUFFLFNBQU5BLElBQUlBLENBQUdKLFFBQWdCLEVBQUs7TUFDMUIsSUFBTW5DLE1BQU0sR0FBR1IsT0FBTyxDQUFDWSxHQUFHLENBQUMrQixRQUFRLENBQUM7TUFDcEMsSUFBSW5DLE1BQU0sRUFBRTtRQUNWUixPQUFPLENBQUNnRCxNQUFNLENBQUN4QyxNQUFNLENBQUNvQyxFQUFFLENBQUM7UUFDekIxQyxhQUFhLEdBQUcsRUFBRTtRQUNsQixLQUFLLElBQU0yQyxFQUFFLElBQUlyQyxNQUFNLENBQUNjLE1BQU0sRUFBRTtVQUM5QnVCLEVBQUUsQ0FBQ0ksY0FBYyxDQUFDekMsTUFBTSxDQUFDb0MsRUFBRSxDQUFDO1FBQzlCO01BQ0Y7SUFDRjtFQUNGLENBQUM7QUFDSDtBQUVBLElBQUlNLFNBQVMsR0FBRyxJQUFJO0FBRWIsU0FBUzNELFdBQVdBLENBQ3pCc0MsT0FBbUIsRUFHWDtFQUFBLElBRlJQLE1BQXVCLEdBQUE2QixTQUFBLENBQUF4QixNQUFBLFFBQUF3QixTQUFBLFFBQUF0QyxTQUFBLEdBQUFzQyxTQUFBLE1BQUcsRUFBRTtFQUFBLElBQzVCMUMsT0FBc0IsR0FBQTBDLFNBQUEsQ0FBQXhCLE1BQUEsUUFBQXdCLFNBQUEsUUFBQXRDLFNBQUEsR0FBQXNDLFNBQUEsTUFBRyxFQUFFO0VBRTNCLElBQU1SLFFBQVEsR0FBSU8sU0FBUyxJQUFJLENBQUU7RUFFakMsSUFBQUUsZ0JBQU8sRUFBQyxZQUFNO0lBQ1osSUFBSUMsY0FBYyxHQUFHQyxNQUFNLENBQUNDLGdCQUFnQjtJQUM1QyxJQUFJRixjQUFjLEtBQUt4QyxTQUFTLEVBQUU7TUFDaEN3QyxjQUFjLEdBQUdDLE1BQU0sQ0FBQ0MsZ0JBQWdCLEdBQUd4RCxvQkFBb0IsQ0FBQyxDQUFDO0lBQ25FO0lBQ0FzRCxjQUFjLENBQUNYLEtBQUssQ0FBQ0MsUUFBUSxFQUFFZCxPQUFPLEVBQUVQLE1BQU0sRUFBRWIsT0FBTyxDQUFDO0VBQzFELENBQUMsQ0FBQyxDQUFDLENBQUM7RUFFSixPQUFPa0MsUUFBUTtBQUNqQjtBQUVPLFNBQVNuRCxVQUFVQSxDQUFDbUQsUUFBZ0IsRUFBUTtFQUNqRCxJQUFBUyxnQkFBTyxFQUFDLFlBQU07SUFDWixJQUFNQyxjQUFjLEdBQUdDLE1BQU0sQ0FBQ0MsZ0JBQWdCO0lBQzlDRixjQUFjLFlBQWRBLGNBQWMsQ0FBRU4sSUFBSSxDQUFDSixRQUFRLENBQUM7RUFDaEMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNOIiwiaWdub3JlTGlzdCI6W119