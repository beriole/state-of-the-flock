{"version":3,"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","NativeEventsManager","_classCallCheck2","_createClass2","_classPrivateFieldLooseBase2","_classPrivateFieldLooseKey2","_utils","_WorkletEventHandler","_reactNative","_managedComponent","default","_componentOptions","_eventViewTag","component","options","writable","getEventViewTag","key","attachEvents","_this","executeForEachEventHandler","props","handler","registerForEvents","detachEvents","_this2","_key","unregisterFromEvents","updateEvents","prevProps","_this3","computedEventTag","prevHandler","newProp","isWorkletEventHandler","workletEventHandler","componentAnimatedRef","_component","newTag","getScrollableNode","_findNodeHandle","scrollableNode","findNodeHandle","_findNodeHandle2","_classPrivateFieldLoo","setNativeProps","prop","has","WorkletEventHandler","callback"],"sources":["NativeEventsManager.ts"],"sourcesContent":["'use strict';\nimport type {\n  INativeEventsManager,\n  IAnimatedComponentInternal,\n  AnimatedComponentProps,\n  InitialComponentProps,\n  AnimatedComponentRef,\n} from './commonTypes';\nimport { has } from './utils';\nimport { WorkletEventHandler } from '../WorkletEventHandler';\nimport { findNodeHandle } from 'react-native';\n\nexport class NativeEventsManager implements INativeEventsManager {\n  readonly #managedComponent: ManagedAnimatedComponent;\n  readonly #componentOptions?: ComponentOptions;\n  #eventViewTag = -1;\n\n  constructor(component: ManagedAnimatedComponent, options?: ComponentOptions) {\n    this.#managedComponent = component;\n    this.#componentOptions = options;\n    this.#eventViewTag = this.getEventViewTag();\n  }\n\n  public attachEvents() {\n    executeForEachEventHandler(this.#managedComponent.props, (key, handler) => {\n      handler.registerForEvents(this.#eventViewTag, key);\n    });\n  }\n\n  public detachEvents() {\n    executeForEachEventHandler(\n      this.#managedComponent.props,\n      (_key, handler) => {\n        handler.unregisterFromEvents(this.#eventViewTag);\n      }\n    );\n  }\n\n  public updateEvents(\n    prevProps: AnimatedComponentProps<InitialComponentProps>\n  ) {\n    const computedEventTag = this.getEventViewTag();\n    // If the event view tag changes, we need to completely re-mount all events\n    if (this.#eventViewTag !== computedEventTag) {\n      // Remove all bindings from previous props that ran on the old viewTag\n      executeForEachEventHandler(prevProps, (_key, handler) => {\n        handler.unregisterFromEvents(this.#eventViewTag);\n      });\n      // We don't need to unregister from current (new) props, because their events weren't registered yet\n      // Replace the view tag\n      this.#eventViewTag = computedEventTag;\n      // Attach the events with a new viewTag\n      this.attachEvents();\n      return;\n    }\n\n    executeForEachEventHandler(prevProps, (key, prevHandler) => {\n      const newProp = this.#managedComponent.props[key];\n      if (!newProp) {\n        // Prop got deleted\n        prevHandler.unregisterFromEvents(this.#eventViewTag);\n      } else if (\n        isWorkletEventHandler(newProp) &&\n        newProp.workletEventHandler !== prevHandler\n      ) {\n        // Prop got changed\n        prevHandler.unregisterFromEvents(this.#eventViewTag);\n        newProp.workletEventHandler.registerForEvents(this.#eventViewTag);\n      }\n    });\n\n    executeForEachEventHandler(this.#managedComponent.props, (key, handler) => {\n      if (!prevProps[key]) {\n        // Prop got added\n        handler.registerForEvents(this.#eventViewTag);\n      }\n    });\n  }\n\n  private getEventViewTag() {\n    // Get the tag for registering events - since the event emitting view can be nested inside the main component\n    const componentAnimatedRef = this.#managedComponent\n      ._component as AnimatedComponentRef;\n    let newTag: number;\n    if (componentAnimatedRef.getScrollableNode) {\n      const scrollableNode = componentAnimatedRef.getScrollableNode();\n      newTag = findNodeHandle(scrollableNode) ?? -1;\n    } else {\n      newTag =\n        findNodeHandle(\n          this.#componentOptions?.setNativeProps\n            ? this.#managedComponent\n            : componentAnimatedRef\n        ) ?? -1;\n    }\n    return newTag;\n  }\n}\n\nfunction isWorkletEventHandler(\n  prop: unknown\n): prop is WorkletEventHandlerHolder {\n  return (\n    has('workletEventHandler', prop) &&\n    prop.workletEventHandler instanceof WorkletEventHandler\n  );\n}\n\nfunction executeForEachEventHandler(\n  props: AnimatedComponentProps<InitialComponentProps>,\n  callback: (\n    key: string,\n    handler: InstanceType<typeof WorkletEventHandler>\n  ) => void\n) {\n  for (const key in props) {\n    const prop = props[key];\n    if (isWorkletEventHandler(prop)) {\n      callback(key, prop.workletEventHandler);\n    }\n  }\n}\n\ntype ManagedAnimatedComponent = React.Component<\n  AnimatedComponentProps<InitialComponentProps>\n> &\n  IAnimatedComponentInternal;\n\ntype ComponentOptions = {\n  setNativeProps: (\n    ref: AnimatedComponentRef,\n    props: InitialComponentProps\n  ) => void;\n};\n\ntype WorkletEventHandlerHolder = {\n  workletEventHandler: InstanceType<typeof WorkletEventHandler>;\n};\n"],"mappings":"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","ignoreList":[]}