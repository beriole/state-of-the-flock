c038459b32a19bbca9bbde9fc12b2c5d
'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.prepareUIRegistry = void 0;
var _threads = require("../threads");
var prepareUIRegistry = exports.prepareUIRegistry = (0, _threads.runOnUIImmediately)(function () {
  'worklet';

  var frameCallbackRegistry = {
    frameCallbackRegistry: new Map(),
    activeFrameCallbacks: new Set(),
    previousFrameTimestamp: null,
    nextCallId: 0,
    runCallbacks: function runCallbacks(callId) {
      var _this = this;
      var _loop = function loop(timestamp) {
        if (callId !== _this.nextCallId) {
          return;
        }
        if (_this.previousFrameTimestamp === null) {
          _this.previousFrameTimestamp = timestamp;
        }
        var delta = timestamp - _this.previousFrameTimestamp;
        _this.activeFrameCallbacks.forEach(function (callbackId) {
          var callbackDetails = _this.frameCallbackRegistry.get(callbackId);
          var startTime = callbackDetails.startTime;
          if (startTime === null) {
            callbackDetails.startTime = timestamp;
            callbackDetails.callback({
              timestamp: timestamp,
              timeSincePreviousFrame: null,
              timeSinceFirstFrame: 0
            });
          } else {
            callbackDetails.callback({
              timestamp: timestamp,
              timeSincePreviousFrame: delta,
              timeSinceFirstFrame: timestamp - startTime
            });
          }
        });
        if (_this.activeFrameCallbacks.size > 0) {
          _this.previousFrameTimestamp = timestamp;
          requestAnimationFrame(_loop);
        } else {
          _this.previousFrameTimestamp = null;
        }
      };
      if (this.activeFrameCallbacks.size === 1 && callId === this.nextCallId) {
        requestAnimationFrame(_loop);
      }
    },
    registerFrameCallback: function registerFrameCallback(callback, callbackId) {
      this.frameCallbackRegistry.set(callbackId, {
        callback: callback,
        startTime: null
      });
    },
    unregisterFrameCallback: function unregisterFrameCallback(callbackId) {
      this.manageStateFrameCallback(callbackId, false);
      this.frameCallbackRegistry.delete(callbackId);
    },
    manageStateFrameCallback: function manageStateFrameCallback(callbackId, state) {
      if (callbackId === -1) {
        return;
      }
      if (state) {
        this.activeFrameCallbacks.add(callbackId);
        this.runCallbacks(this.nextCallId);
      } else {
        var callback = this.frameCallbackRegistry.get(callbackId);
        callback.startTime = null;
        this.activeFrameCallbacks.delete(callbackId);
        if (this.activeFrameCallbacks.size === 0) {
          this.nextCallId += 1;
        }
      }
    }
  };
  global._frameCallbackRegistry = frameCallbackRegistry;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInByZXBhcmVVSVJlZ2lzdHJ5IiwiX3RocmVhZHMiLCJyZXF1aXJlIiwicnVuT25VSUltbWVkaWF0ZWx5IiwiZnJhbWVDYWxsYmFja1JlZ2lzdHJ5IiwiTWFwIiwiYWN0aXZlRnJhbWVDYWxsYmFja3MiLCJTZXQiLCJwcmV2aW91c0ZyYW1lVGltZXN0YW1wIiwibmV4dENhbGxJZCIsInJ1bkNhbGxiYWNrcyIsImNhbGxJZCIsIl90aGlzIiwibG9vcCIsInRpbWVzdGFtcCIsImRlbHRhIiwiZm9yRWFjaCIsImNhbGxiYWNrSWQiLCJjYWxsYmFja0RldGFpbHMiLCJnZXQiLCJzdGFydFRpbWUiLCJjYWxsYmFjayIsInRpbWVTaW5jZVByZXZpb3VzRnJhbWUiLCJ0aW1lU2luY2VGaXJzdEZyYW1lIiwic2l6ZSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInJlZ2lzdGVyRnJhbWVDYWxsYmFjayIsInNldCIsInVucmVnaXN0ZXJGcmFtZUNhbGxiYWNrIiwibWFuYWdlU3RhdGVGcmFtZUNhbGxiYWNrIiwiZGVsZXRlIiwic3RhdGUiLCJhZGQiLCJnbG9iYWwiLCJfZnJhbWVDYWxsYmFja1JlZ2lzdHJ5Il0sInNvdXJjZXMiOlsiRnJhbWVDYWxsYmFja1JlZ2lzdHJ5VUkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuaW1wb3J0IHsgcnVuT25VSUltbWVkaWF0ZWx5IH0gZnJvbSAnLi4vdGhyZWFkcyc7XG5cbnR5cGUgQ2FsbGJhY2tEZXRhaWxzID0ge1xuICBjYWxsYmFjazogKGZyYW1lSW5mbzogRnJhbWVJbmZvKSA9PiB2b2lkO1xuICBzdGFydFRpbWU6IG51bWJlciB8IG51bGw7XG59O1xuXG5leHBvcnQgdHlwZSBGcmFtZUluZm8gPSB7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICB0aW1lU2luY2VQcmV2aW91c0ZyYW1lOiBudW1iZXIgfCBudWxsO1xuICB0aW1lU2luY2VGaXJzdEZyYW1lOiBudW1iZXI7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEZyYW1lQ2FsbGJhY2tSZWdpc3RyeVVJIHtcbiAgZnJhbWVDYWxsYmFja1JlZ2lzdHJ5OiBNYXA8bnVtYmVyLCBDYWxsYmFja0RldGFpbHM+O1xuICBhY3RpdmVGcmFtZUNhbGxiYWNrczogU2V0PG51bWJlcj47XG4gIHByZXZpb3VzRnJhbWVUaW1lc3RhbXA6IG51bWJlciB8IG51bGw7XG4gIHJ1bkNhbGxiYWNrczogKGNhbGxJZDogbnVtYmVyKSA9PiB2b2lkO1xuICBuZXh0Q2FsbElkOiBudW1iZXI7XG4gIHJlZ2lzdGVyRnJhbWVDYWxsYmFjazogKFxuICAgIGNhbGxiYWNrOiAoZnJhbWVJbmZvOiBGcmFtZUluZm8pID0+IHZvaWQsXG4gICAgY2FsbGJhY2tJZDogbnVtYmVyXG4gICkgPT4gdm9pZDtcbiAgdW5yZWdpc3RlckZyYW1lQ2FsbGJhY2s6IChjYWxsYmFja0lkOiBudW1iZXIpID0+IHZvaWQ7XG4gIG1hbmFnZVN0YXRlRnJhbWVDYWxsYmFjazogKGNhbGxiYWNrSWQ6IG51bWJlciwgc3RhdGU6IGJvb2xlYW4pID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBjb25zdCBwcmVwYXJlVUlSZWdpc3RyeSA9IHJ1bk9uVUlJbW1lZGlhdGVseSgoKSA9PiB7XG4gICd3b3JrbGV0JztcblxuICBjb25zdCBmcmFtZUNhbGxiYWNrUmVnaXN0cnk6IEZyYW1lQ2FsbGJhY2tSZWdpc3RyeVVJID0ge1xuICAgIGZyYW1lQ2FsbGJhY2tSZWdpc3RyeTogbmV3IE1hcDxudW1iZXIsIENhbGxiYWNrRGV0YWlscz4oKSxcbiAgICBhY3RpdmVGcmFtZUNhbGxiYWNrczogbmV3IFNldDxudW1iZXI+KCksXG4gICAgcHJldmlvdXNGcmFtZVRpbWVzdGFtcDogbnVsbCxcbiAgICBuZXh0Q2FsbElkOiAwLFxuXG4gICAgcnVuQ2FsbGJhY2tzKGNhbGxJZCkge1xuICAgICAgY29uc3QgbG9vcCA9ICh0aW1lc3RhbXA6IG51bWJlcikgPT4ge1xuICAgICAgICBpZiAoY2FsbElkICE9PSB0aGlzLm5leHRDYWxsSWQpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucHJldmlvdXNGcmFtZVRpbWVzdGFtcCA9PT0gbnVsbCkge1xuICAgICAgICAgIHRoaXMucHJldmlvdXNGcmFtZVRpbWVzdGFtcCA9IHRpbWVzdGFtcDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRlbHRhID0gdGltZXN0YW1wIC0gdGhpcy5wcmV2aW91c0ZyYW1lVGltZXN0YW1wO1xuXG4gICAgICAgIHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3MuZm9yRWFjaCgoY2FsbGJhY2tJZDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgY29uc3QgY2FsbGJhY2tEZXRhaWxzID0gdGhpcy5mcmFtZUNhbGxiYWNrUmVnaXN0cnkuZ2V0KGNhbGxiYWNrSWQpITtcblxuICAgICAgICAgIGNvbnN0IHsgc3RhcnRUaW1lIH0gPSBjYWxsYmFja0RldGFpbHM7XG5cbiAgICAgICAgICBpZiAoc3RhcnRUaW1lID09PSBudWxsKSB7XG4gICAgICAgICAgICAvLyBGaXJzdCBmcmFtZVxuICAgICAgICAgICAgY2FsbGJhY2tEZXRhaWxzLnN0YXJ0VGltZSA9IHRpbWVzdGFtcDtcblxuICAgICAgICAgICAgY2FsbGJhY2tEZXRhaWxzLmNhbGxiYWNrKHtcbiAgICAgICAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICAgICAgICB0aW1lU2luY2VQcmV2aW91c0ZyYW1lOiBudWxsLFxuICAgICAgICAgICAgICB0aW1lU2luY2VGaXJzdEZyYW1lOiAwLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIE5leHQgZnJhbWVcbiAgICAgICAgICAgIGNhbGxiYWNrRGV0YWlscy5jYWxsYmFjayh7XG4gICAgICAgICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgICAgICAgdGltZVNpbmNlUHJldmlvdXNGcmFtZTogZGVsdGEsXG4gICAgICAgICAgICAgIHRpbWVTaW5jZUZpcnN0RnJhbWU6IHRpbWVzdGFtcCAtIHN0YXJ0VGltZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3Muc2l6ZSA+IDApIHtcbiAgICAgICAgICB0aGlzLnByZXZpb3VzRnJhbWVUaW1lc3RhbXAgPSB0aW1lc3RhbXA7XG4gICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGxvb3ApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucHJldmlvdXNGcmFtZVRpbWVzdGFtcCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIC8vIHJ1bkNhbGxiYWNrKCkgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGFmdGVyIHJlZ2lzdGVyaW5nIGEgY2FsbGJhY2ssXG4gICAgICAvLyBzbyBpZiB0aGVyZSBpcyBvbmx5IG9uZSBhY3RpdmUgY2FsbGJhY2ssIHRoZW4gaXQgbWVhbnMgdGhhdCB0aGVyZSB3ZXJlXG4gICAgICAvLyB6ZXJvIHByZXZpb3VzbHkgYW5kIHRoZSBsb29wIGlzbid0IHJ1bm5pbmcgeWV0LlxuICAgICAgaWYgKHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3Muc2l6ZSA9PT0gMSAmJiBjYWxsSWQgPT09IHRoaXMubmV4dENhbGxJZCkge1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobG9vcCk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIHJlZ2lzdGVyRnJhbWVDYWxsYmFjayhcbiAgICAgIGNhbGxiYWNrOiAoZnJhbWVJbmZvOiBGcmFtZUluZm8pID0+IHZvaWQsXG4gICAgICBjYWxsYmFja0lkOiBudW1iZXJcbiAgICApIHtcbiAgICAgIHRoaXMuZnJhbWVDYWxsYmFja1JlZ2lzdHJ5LnNldChjYWxsYmFja0lkLCB7XG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBzdGFydFRpbWU6IG51bGwsXG4gICAgICB9KTtcbiAgICB9LFxuXG4gICAgdW5yZWdpc3RlckZyYW1lQ2FsbGJhY2soY2FsbGJhY2tJZDogbnVtYmVyKSB7XG4gICAgICB0aGlzLm1hbmFnZVN0YXRlRnJhbWVDYWxsYmFjayhjYWxsYmFja0lkLCBmYWxzZSk7XG4gICAgICB0aGlzLmZyYW1lQ2FsbGJhY2tSZWdpc3RyeS5kZWxldGUoY2FsbGJhY2tJZCk7XG4gICAgfSxcblxuICAgIG1hbmFnZVN0YXRlRnJhbWVDYWxsYmFjayhjYWxsYmFja0lkOiBudW1iZXIsIHN0YXRlOiBib29sZWFuKSB7XG4gICAgICBpZiAoY2FsbGJhY2tJZCA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgIHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3MuYWRkKGNhbGxiYWNrSWQpO1xuICAgICAgICB0aGlzLnJ1bkNhbGxiYWNrcyh0aGlzLm5leHRDYWxsSWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSB0aGlzLmZyYW1lQ2FsbGJhY2tSZWdpc3RyeS5nZXQoY2FsbGJhY2tJZCkhO1xuICAgICAgICBjYWxsYmFjay5zdGFydFRpbWUgPSBudWxsO1xuXG4gICAgICAgIHRoaXMuYWN0aXZlRnJhbWVDYWxsYmFja3MuZGVsZXRlKGNhbGxiYWNrSWQpO1xuICAgICAgICBpZiAodGhpcy5hY3RpdmVGcmFtZUNhbGxiYWNrcy5zaXplID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5uZXh0Q2FsbElkICs9IDE7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuICB9O1xuXG4gIGdsb2JhbC5fZnJhbWVDYWxsYmFja1JlZ2lzdHJ5ID0gZnJhbWVDYWxsYmFja1JlZ2lzdHJ5O1xufSk7XG4iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBQUFBLE1BQUEsQ0FBQUMsY0FBQSxDQUFBQyxPQUFBO0VBQUFDLEtBQUE7QUFBQTtBQUFBRCxPQUFBLENB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